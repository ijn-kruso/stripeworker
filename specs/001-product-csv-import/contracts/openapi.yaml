openapi: 3.1.0
info:
  title: StripeWorker Product CSV API
  version: 1.0.0
  description: |
    REST API for Stripe product CSV import/export operations.
    Runs on Cloudflare Workers with KV/R2 storage.
    
    ## Authentication
    This API is called from Stripe Apps UI extensions embedded in the Stripe Dashboard.
    All requests must include:
    - `Stripe-Signature` header: Generated by `fetchStripeSignature()` from UI extension
    - `user_id` in request body: Current Stripe user ID
    - `account_id` in request body: Current Stripe account ID
    
    The backend verifies the signature using the app's signing secret before processing.

servers:
  - url: https://api.stripeworker.com
    description: Production API
  - url: http://localhost:8787
    description: Local development (wrangler dev)

security:
  - StripeSignature: []

paths:
  # ============== Export ==============
  /export/start:
    post:
      operationId: startExport
      summary: Start a product export job
      description: |
        Initiates export of all products to CSV.
        Returns immediately with job ID for polling.
      tags: [Export]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignedRequest'
      responses:
        '202':
          description: Export job created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /export/{jobId}/download:
    get:
      operationId: downloadExport
      summary: Download exported CSV file
      description: Returns presigned R2 URL for CSV download
      tags: [Export]
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: Download URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  downloadUrl:
                    type: string
                    format: uri
                    description: Presigned URL valid for 1 hour
                required:
                  - downloadUrl
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Export not yet complete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============== Import ==============
  /import/upload-url:
    post:
      operationId: getImportUploadUrl
      summary: Get presigned URL for CSV upload
      description: Returns presigned R2 URL for direct upload
      tags: [Import]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/SignedRequest'
                - type: object
                  properties:
                    filename:
                      type: string
                      description: Original filename
                    contentType:
                      type: string
                      default: text/csv
                  required:
                    - filename
      responses:
        '200':
          description: Upload URL and job ID
          content:
            application/json:
              schema:
                type: object
                properties:
                  uploadUrl:
                    type: string
                    format: uri
                    description: Presigned PUT URL valid for 5 minutes
                  jobId:
                    type: string
                    format: uuid
                required:
                  - uploadUrl
                  - jobId
        '401':
          $ref: '#/components/responses/Unauthorized'

  /import/{jobId}/start:
    post:
      operationId: startImport
      summary: Start processing uploaded CSV
      description: |
        Begins import job after CSV upload is complete.
        Use dry-run mode to preview changes without modifying Stripe.
      tags: [Import]
      parameters:
        - $ref: '#/components/parameters/JobId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/SignedRequest'
                - type: object
                  properties:
                    dryRun:
                      type: boolean
                      default: false
                      description: Preview changes without applying
                    mappingId:
                      type: string
                      format: uuid
                      description: Optional field mapping configuration ID
      responses:
        '202':
          description: Import job started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Job already started or file not uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /import/{jobId}/process:
    post:
      operationId: processImportChunk
      summary: Process next chunk of import rows
      description: |
        Processes a batch of rows from the import CSV.
        Called repeatedly by client until job is complete.
        Implements client-side chunking for 50ms CPU limit compliance.
      tags: [Import]
      parameters:
        - $ref: '#/components/parameters/JobId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                batchSize:
                  type: integer
                  minimum: 1
                  maximum: 500
                  default: 100
                  description: Number of rows to process in this chunk
      responses:
        '200':
          description: Chunk processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Job not in processing state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /import/{jobId}/errors:
    get:
      operationId: downloadImportErrors
      summary: Download error CSV with failed rows
      description: Returns presigned R2 URL for error CSV download
      tags: [Import]
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: Download URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  downloadUrl:
                    type: string
                    format: uri
                  errorCount:
                    type: integer
                required:
                  - downloadUrl
                  - errorCount
        '404':
          $ref: '#/components/responses/NotFound'

  # ============== Jobs ==============
  /jobs:
    get:
      operationId: listJobs
      summary: List all jobs for connected account
      tags: [Jobs]
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [import, export]
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/JobStatus'
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of jobs
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'
                required:
                  - jobs

  /jobs/{jobId}:
    get:
      operationId: getJob
      summary: Get job status and details
      tags: [Jobs]
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      operationId: cancelJob
      summary: Cancel a running job
      tags: [Jobs]
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: Job cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Job cannot be cancelled (already complete)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============== Field Mappings (P4) ==============
  /mappings:
    get:
      operationId: listMappings
      summary: List saved field mappings
      tags: [Field Mappings]
      responses:
        '200':
          description: List of mappings
          content:
            application/json:
              schema:
                type: object
                properties:
                  mappings:
                    type: array
                    items:
                      $ref: '#/components/schemas/FieldMapping'
    post:
      operationId: createMapping
      summary: Create a new field mapping
      tags: [Field Mappings]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FieldMappingInput'
      responses:
        '201':
          description: Mapping created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FieldMapping'

  /mappings/{mappingId}:
    get:
      operationId: getMapping
      summary: Get a field mapping
      tags: [Field Mappings]
      parameters:
        - name: mappingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Mapping details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FieldMapping'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      operationId: updateMapping
      summary: Update a field mapping
      tags: [Field Mappings]
      parameters:
        - name: mappingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FieldMappingInput'
      responses:
        '200':
          description: Mapping updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FieldMapping'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      operationId: deleteMapping
      summary: Delete a field mapping
      tags: [Field Mappings]
      parameters:
        - name: mappingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Mapping deleted
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    StripeSignature:
      type: apiKey
      in: header
      name: Stripe-Signature
      description: |
        Signature generated by `fetchStripeSignature()` from Stripe Apps UI extension SDK.
        Backend verifies using app's signing secret via `stripe.webhooks.signature.verifyHeader()`.

  parameters:
    JobId:
      name: jobId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    SignedRequest:
      type: object
      description: Base schema for all authenticated requests from Stripe Apps UI
      properties:
        user_id:
          type: string
          description: Stripe user ID from userContext.id
          example: usr_K6yd2CbXLO9A5G
        account_id:
          type: string
          description: Stripe account ID from userContext.account.id
          example: acct_1JSkf6FRwUQjTSJE
      required:
        - user_id
        - account_id

    Job:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [import, export]
        status:
          $ref: '#/components/schemas/JobStatus'
        totalRows:
          type: integer
        processedRows:
          type: integer
        createdCount:
          type: integer
          description: Import only - products created
        updatedCount:
          type: integer
          description: Import only - products updated
        skippedCount:
          type: integer
          description: Import only - rows skipped due to errors
        errorCount:
          type: integer
        dryRun:
          type: boolean
          description: Import only - whether this is a preview
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
      required:
        - id
        - type
        - status
        - totalRows
        - processedRows
        - createdAt
        - updatedAt

    JobStatus:
      type: string
      enum:
        - pending
        - processing
        - completed
        - failed
        - cancelled

    FieldMapping:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/ColumnMapping'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - name
        - mappings
        - createdAt
        - updatedAt

    FieldMappingInput:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/ColumnMapping'
          minItems: 1
      required:
        - name
        - mappings

    ColumnMapping:
      type: object
      properties:
        csvColumn:
          type: string
          description: Column header in CSV file
        stripeField:
          type: string
          description: Stripe product field (id, name, description, active, metadata.*, image.*)
        transform:
          type: string
          enum: [none, boolean, trim, lowercase]
          default: none
      required:
        - csvColumn
        - stripeField

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
      required:
        - error

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

tags:
  - name: Export
    description: Export products to CSV
  - name: Import
    description: Import products from CSV
  - name: Jobs
    description: Job status and management
  - name: Field Mappings
    description: Custom CSV column mappings (P4)
